{"version":3,"sources":["turbopack:///[project]/Desktop/walletconnect/chilly/node_modules/viem/clients/transports/webSocket.ts"],"sourcesContent":["import type { Address } from 'abitype'\nimport { RpcRequestError } from '../../errors/request.js'\nimport {\n  UrlRequiredError,\n  type UrlRequiredErrorType,\n} from '../../errors/transport.js'\nimport type { ErrorType } from '../../errors/utils.js'\nimport type { Hash, LogTopic } from '../../types/misc.js'\nimport type { RpcResponse } from '../../types/rpc.js'\nimport { getSocket } from '../../utils/rpc/compat.js'\nimport type { SocketRpcClient } from '../../utils/rpc/socket.js'\nimport {\n  type GetWebSocketRpcClientOptions,\n  getWebSocketRpcClient,\n} from '../../utils/rpc/webSocket.js'\nimport {\n  type CreateTransportErrorType,\n  createTransport,\n  type Transport,\n  type TransportConfig,\n} from './createTransport.js'\n\ntype WebSocketTransportSubscribeParameters = {\n  onData: (data: RpcResponse) => void\n  onError?: ((error: any) => void) | undefined\n}\n\ntype WebSocketTransportSubscribeReturnType = {\n  subscriptionId: Hash\n  unsubscribe: () => Promise<RpcResponse<boolean>>\n}\n\ntype WebSocketTransportSubscribe = {\n  subscribe(\n    args: WebSocketTransportSubscribeParameters &\n      (\n        | {\n            params: ['newHeads']\n          }\n        | {\n            params: ['newPendingTransactions']\n          }\n        | {\n            params: [\n              'logs',\n              {\n                address?: Address | Address[]\n                topics?: LogTopic[]\n              },\n            ]\n          }\n        | {\n            params: ['syncing']\n          }\n      ),\n  ): Promise<WebSocketTransportSubscribeReturnType>\n}\n\nexport type WebSocketTransportConfig = {\n  /**\n   * Whether or not to send keep-alive ping messages.\n   * @default true\n   */\n  keepAlive?: GetWebSocketRpcClientOptions['keepAlive'] | undefined\n  /** The key of the WebSocket transport. */\n  key?: TransportConfig['key'] | undefined\n  /** Methods to include or exclude from executing RPC requests. */\n  methods?: TransportConfig['methods'] | undefined\n  /** The name of the WebSocket transport. */\n  name?: TransportConfig['name'] | undefined\n  /**\n   * Whether or not to attempt to reconnect on socket failure.\n   * @default true\n   */\n  reconnect?: GetWebSocketRpcClientOptions['reconnect'] | undefined\n  /** The max number of times to retry. */\n  retryCount?: TransportConfig['retryCount'] | undefined\n  /** The base delay (in ms) between retries. */\n  retryDelay?: TransportConfig['retryDelay'] | undefined\n  /** The timeout (in ms) for async WebSocket requests. Default: 10_000 */\n  timeout?: TransportConfig['timeout'] | undefined\n}\n\nexport type WebSocketTransport = Transport<\n  'webSocket',\n  {\n    /**\n     * @deprecated use `getRpcClient` instead.\n     */\n    getSocket(): Promise<WebSocket>\n    getRpcClient(): Promise<SocketRpcClient<WebSocket>>\n    subscribe: WebSocketTransportSubscribe['subscribe']\n  }\n>\n\nexport type WebSocketTransportErrorType =\n  | CreateTransportErrorType\n  | UrlRequiredErrorType\n  | ErrorType\n\n/**\n * @description Creates a WebSocket transport that connects to a JSON-RPC API.\n */\nexport function webSocket(\n  /** URL of the JSON-RPC API. Defaults to the chain's public RPC URL. */\n  url?: string,\n  config: WebSocketTransportConfig = {},\n): WebSocketTransport {\n  const {\n    keepAlive,\n    key = 'webSocket',\n    methods,\n    name = 'WebSocket JSON-RPC',\n    reconnect,\n    retryDelay,\n  } = config\n  return ({ chain, retryCount: retryCount_, timeout: timeout_ }) => {\n    const retryCount = config.retryCount ?? retryCount_\n    const timeout = timeout_ ?? config.timeout ?? 10_000\n    const url_ = url || chain?.rpcUrls.default.webSocket?.[0]\n    const wsRpcClientOpts = { keepAlive, reconnect }\n    if (!url_) throw new UrlRequiredError()\n    return createTransport(\n      {\n        key,\n        methods,\n        name,\n        async request({ method, params }) {\n          const body = { method, params }\n          const rpcClient = await getWebSocketRpcClient(url_, wsRpcClientOpts)\n          const { error, result } = await rpcClient.requestAsync({\n            body,\n            timeout,\n          })\n          if (error)\n            throw new RpcRequestError({\n              body,\n              error,\n              url: url_,\n            })\n          return result\n        },\n        retryCount,\n        retryDelay,\n        timeout,\n        type: 'webSocket',\n      },\n      {\n        getSocket() {\n          return getSocket(url_)\n        },\n        getRpcClient() {\n          return getWebSocketRpcClient(url_, wsRpcClientOpts)\n        },\n        async subscribe({ params, onData, onError }: any) {\n          const rpcClient = await getWebSocketRpcClient(url_, wsRpcClientOpts)\n          const { result: subscriptionId } = await new Promise<any>(\n            (resolve, reject) =>\n              rpcClient.request({\n                body: {\n                  method: 'eth_subscribe',\n                  params,\n                },\n                onError(error) {\n                  reject(error)\n                  onError?.(error)\n                  return\n                },\n                onResponse(response) {\n                  if (response.error) {\n                    reject(response.error)\n                    onError?.(response.error)\n                    return\n                  }\n\n                  if (typeof response.id === 'number') {\n                    resolve(response)\n                    return\n                  }\n                  if (response.method !== 'eth_subscription') return\n                  onData(response.params)\n                },\n              }),\n          )\n          return {\n            subscriptionId,\n            async unsubscribe() {\n              return new Promise<any>((resolve) =>\n                rpcClient.request({\n                  body: {\n                    method: 'eth_unsubscribe',\n                    params: [subscriptionId],\n                  },\n                  onResponse: resolve,\n                }),\n              )\n            },\n          }\n        },\n      },\n    )\n  }\n}\n"],"names":[],"mappings":"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"}